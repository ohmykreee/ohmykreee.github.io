'use strict';(function(){var $tpl=$('.template-transfer');var $footer=$tpl.find('.footer');var $contextmenu=$tpl.find('.contextmenu');var addEntry=function addEntry(entry,updateTable){var $table=$tpl.find('.tab-container.status-'+entry.status).find('table');var $tbody=$table.find('tbody');var $tr=$('#transfer-entry-'+entry.id);if(!$tr.length){$tr=$table.find('tbody tr.boilerplate').clone();$tr.attr('id','transfer-entry-'+entry.id);$tr.removeClass('boilerplate');$tbody.append($tr)}$tr.data('entry',entry);$tr.attr('data-id',entry.id);$tr.find('.id').text(entry.id);$tr.find('.server').text(entry.serverName);$tr.find('.mode').text(gl.t('mode.'+entry.mode));$tr.find('.server-path').text(entry.serverPath);$tr.find('.local-path').text(entry.localPath);$tr.find('.size').text(gl.humanFilesize(entry.size));if(updateTable){$table.trigger('update');updateEntryCounter()}};var updateEntryCounter=function updateEntryCounter(){$tpl.find('table').each(function(){var $tabContainer=$(this).closest('.tab-container');var $tab=$tpl.find('.tab').filter('[data-id=\''+$tabContainer.attr('data-id')+'\']');var $trs=$(this).find('tbody').children().not('.boilerplate');$tab.find('.counter').text('('+$trs.length+')');if($(this).closest('.tab-container').attr('data-id')==='transfer.queue'){var size=0;$tpl.find('.tab-container').filter('.status-queue, .status-transfering').find('tbody tr').not('.boilerplate').each(function(){size+=$(this).data('entry').size});$footer.find('.total-size .number').text(gl.humanFilesize(size))}});updateTransferSpeed()};var loadTransfers=function loadTransfers(callback){gl.socket.send('getTransfers',null,function(entries){var $tableBoiler=$tpl.find('.boilerplate.table-files').clone();$tableBoiler.removeClass('boilerplate');$tpl.find('.tab-container.transfers').html($tableBoiler);var entryKeys=Object.keys(entries);var createEntriesHtml=function createEntriesHtml(){for(var i=0;i<30;i++){if(!entryKeys.length)break;var k=entryKeys.shift();addEntry(entries[k])}if(entryKeys.length){setTimeout(createEntriesHtml,50)}updateEntryCounter()};createEntriesHtml();$tpl.find('.tab-container').find('table').tablesorter({textExtraction:function textExtraction(node){var n=$(node);return(n.attr('data-sortvalue')||n.text()).toLowerCase()}}).on('sortEnd',function(){var $table=$(this).closest('table');if($table.hasClass('status-queue')){}});if(callback)callback()})};$contextmenu.on('click','.start',function(){gl.socket.send('startTransfer')});$contextmenu.on('click','.stop',function(){gl.socket.send('stopTransfer',null,function(){loadTransfers()})});$contextmenu.on('click','.remove, .move',function(){var $selectedEntries=$tpl.find('tr.active');var entries=[];$selectedEntries.each(function(){entries.push($(this).attr('data-id'))});updateEntryCounter();gl.socket.send($(this).attr('data-action'),{'entries':entries})});var updateTransferSpeed=function updateTransferSpeed(){var $trs=$tpl.find('.tab-container.status-transfering').find('tbody tr').not('.boilerplate');var currentTransferSpeed=0;$trs.each(function(){currentTransferSpeed+=$(this).data('speed')||0});$tpl.find('.transfer-speed .number').text(gl.humanFilesize(currentTransferSpeed)+'/s')};loadTransfers(function(){gl.socket.bind(function(message){if(message.action==='transfer-add-bulk'){if(message.message.messages){for(var i=0;i<message.message.messages.length;i++){for(var j=0;j<message.message.messages[i].length;j++){addEntry(message.message.messages[i][j])}}updateEntryCounter()}}if(message.action==='transfer-status-update'){for(var _i=0;_i<message.message.messages.length;_i++){var $entry=$('#transfer-entry-'+message.message.messages[_i].id);$tpl.find('.tab-container.status-'+message.message.messages[_i].status).find('tbody').append($entry)}$('.table-files').trigger('update',[true]);updateEntryCounter()}if(message.action==='transfer-removed'){var entries=message.message.messages;if(entries){for(var _i2=0;_i2<entries.length;_i2++){for(var _j=0;_j<entries[_i2].length;_j++){$('#transfer-entry-'+entries[_i2][_j]).remove()}}}updateEntryCounter()}if(message.action==='transfer-progress'){var files=message.message.messages;if(files){for(var _i3=0;_i3<files.length;_i3++){var file=files[_i3];var entry=$('#transfer-entry-'+file.id);var percent=100/file.filesize*file.transfered;entry.data('speed',file.speedAverage);entry.data('transfered',file.transfered);entry.attr('data-sortvalue',percent);entry.find('.text').text(parseInt(percent)+'%');entry.find('.progress-bar-info').css('width',percent+'%')}}updateTransferSpeed()}})});updateTransferSpeed()})();