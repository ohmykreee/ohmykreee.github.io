'use strict';(function(){var $tpl=$('.template-usermanager');var $tree=$tpl.find('.tree');var users={};var editId=null;var loadForm=function loadForm(values){var forms={'general':{'username':{'type':'text','label':'username','required':true},'password':{'type':'password','label':'password','description':'password.description','required':!editId},'admin':{'type':'switch','label':'administrator','description':'administrator.description'},'loginHash':{'type':'text','label':'loginhash','description':'loginhash.description','showIf':function showIf(){return!!editId}}}};for(var i in forms){var $form=$('.template-usermanager .form-'+i);$form.html('');gl.form.create($form,'server-'+i,forms[i],function(){var formData={};$tpl.find('.form form').each(function(){$.extend(formData,$(this).serializeJSON())});gl.socket.send('usermanagerFormSubmit',{'formData':formData,'id':editId},function(result){if(result===true){gl.note(gl.t('saved'),'success');gl.splitbox.tabReload()}else{gl.note(gl.t('administrator.missing'),'danger')}})},function(){gl.splitbox.tabReload()},values)}};var loadUsers=function loadUsers(){gl.socket.send('getUsers',null,function(userlist){users=userlist;$tree.find('.entry').not('.boilerplate').remove();for(var userIndex in users){if(users.hasOwnProperty(userIndex)){var userRow=users[userIndex];var $entry=$tree.find('.boilerplate').clone();$entry.removeClass('boilerplate');$entry.find('.name').text(userRow.username);$entry.find('.administrator').text(userRow.admin?gl.t('administrator'):'');$entry.attr('data-id',userRow.id);$tree.append($entry)}}})};$tpl.on('click','.user-add',function(){editId=null;loadForm()}).on('click','.tree .entry',function(){$tree.find('.entry').removeClass('active');$(this).addClass('active');editId=$(this).attr('data-id');loadForm(users[$(this).attr('data-id')])}).on('click','.tree .glyphicon-remove',function(ev){ev.stopPropagation();var $e=$(this).closest('.entry');var userId=$e.attr('data-id');gl.modalConfirm(gl.t('sure'),function(result){if(result===true){gl.socket.send('removeUser',{'userId':userId},function(result){if(result===true){$e.remove()}else{gl.note('administrator.missing','danger')}})}})});loadForm();loadUsers()})();